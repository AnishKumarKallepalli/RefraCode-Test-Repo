# refracode-workflow-v5
name: RefraCode Tests
on:
  pull_request:
    paths:
      - 'tests/refracode_generated/**'

jobs:
  refracode-tests:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # required for OIDC token exchange
      contents: read

    steps:
      - uses: actions/checkout@v3

      - name: Setup environment
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt 2>/dev/null || true && pip install pytest pytest-json-report

      - name: Run RefraCode tests
        id: run-tests
        continue-on-error: true
        env:
          # PYTHONPATH lets the generated tests import your project's source code
          PYTHONPATH: ${{ github.workspace }}
        run: pytest tests/refracode_generated/ --json-report --json-report-file=test-results.json; true

      - name: Get OIDC token
        id: oidc
        if: always()
        run: |
          TOKEN=$(curl -s             -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN"             "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=refracode"             | python3 -c "import sys,json; print(json.load(sys.stdin)['value'])")
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Report results to RefraCode
        if: always()
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python3 -c "
          import json, os, sys
          try:
            with open('test-results.json') as f:
              res = json.load(f)
          except Exception:
            res = {'exitcode': -1, 'summary': {}, 'tests': [], 'collectors': []}
          payload = {'pr_number': int(os.environ.get('PR_NUMBER', 0)), 'repo': os.environ.get('REPO', ''), 'results': res}
          print(json.dumps(payload))
          " > payload.json
          curl -s -X POST https://refracode-backend-production.up.railway.app/webhook/test-results \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.token }}" \
            -d @payload.json || true

      - name: Fail if RefraCode tests failed
        if: always() && steps.run-tests.outcome == 'failure'
        run: |
          echo "RefraCode tests failed. See the PR comment for details on which contracts were violated."
          exit 1
